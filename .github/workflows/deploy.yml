name: "Project Hydra: Infrastructure Dispatch (OIDC)"

on:
  push:
    branches: [ "main" ]
    paths: [ "terraform/**", "resources/**" ]
  pull_request:
    branches: [ "main" ]
    paths: [ "terraform/**", "resources/**" ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Operational Task'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - redeploy_c2_node
        - destroy_ephemeral
        - full_burn

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write   # Required for requesting the JWT
  contents: read    # Required for actions/checkout
  pull-requests: write

env:
  TF_ROOT: terraform/live/production  # Updated to match Phase 6
  TF_VERSION: 1.13.1                  # Updated to latest stable
  AWS_REGION: us-east-1 
  # REPLACE WITH YOUR ACCOUNT ID
  IAM_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole

jobs:
  lint-and-scan:
    name: "üõ°Ô∏è Security & Linting"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: Terraform Format Check
        run: terraform fmt -recursive
        working-directory: .
        
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform/modules
          soft_fail: true # Set to false to block builds on security issues

  terraform-plan:
    name: "üìù Terraform Plan"
    needs: lint-and-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: Hydra-TF-Plan

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_ROOT }}
        run: terraform init

      - name: Terraform Validate
        id: validate
        working-directory: ${{ env.TF_ROOT }}
        run: terraform validate -no-color

      # --- ADVANCED LOGIC: BYPASS SAFETY GUARDS ---
      - name: Disable Lifecycle Guard (Full Burn Only)
        if: github.event.inputs.action == 'full_burn'
        run: |
          # Removes prevent_destroy and enables force_destroy on the S3 Vault
          sed -i 's/prevent_destroy = true/prevent_destroy = false/g' terraform/modules/aws/storage/main.tf
          sed -i 's/force_destroy = false/force_destroy = true/g' terraform/modules/aws/storage/main.tf

      # --- SURGICAL LOGIC: RE-ROLLING ASG ---
      - name: Taint Resources (Redeploy)
        if: github.event.inputs.action == 'redeploy_c2_node'
        working-directory: ${{ env.TF_ROOT }}
        run: |
          # Tainting the Launch Template forces the ASG to see a "new" version
          # This triggers the Instance Refresh defined in Phase 5
          terraform taint module.autoscaling.aws_launch_template.c2_template || true
          
      - name: Terraform Refresh
        working-directory: ${{ env.TF_ROOT }}
        env:
          TF_VAR_my_ip: ${{ secrets.ADMIN_IP_CIDR }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform refresh

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_ROOT }}
        env:
          TF_VAR_my_ip: ${{ secrets.ADMIN_IP_CIDR }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "destroy_ephemeral" ]; then
            # Target only the "Frontend" modules, leaving Storage (S3) and Identity (IAM) intact
            terraform plan -destroy \
              -target=module.autoscaling \
              -target=module.load_balancing \
              -target=module.cdn \
              -target=module.security \
              -out=tfplan
          elif [ "${{ github.event.inputs.action }}" == "full_burn" ]; then
            terraform plan -destroy -out=tfplan
          else
            terraform plan -out=tfplan
          fi

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.TF_ROOT }}/tfplan
          retention-days: 1
          overwrite: true 

  terraform-apply:
    name: "üöÄ Terraform Apply"
    needs: terraform-plan
    # Run on main push OR if manual action is triggered (excluding 'plan' only)
    if: (github.ref == 'refs/heads/main' && github.event_name != 'pull_request') || (github.event_name == 'workflow_dispatch' && github.event.inputs.action != 'plan')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: Hydra-TF-Apply

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_ROOT }}
        run: terraform init -input=false -no-color

      # --- REPEAT SAFETY BYPASS FOR APPLY PHASE ---
      - name: Disable Lifecycle Guard (Full Burn Only)
        if: github.event.inputs.action == 'full_burn'
        run: |
          sed -i 's/prevent_destroy = true/prevent_destroy = false/g' terraform/modules/aws/storage/main.tf
          sed -i 's/force_destroy = false/force_destroy = true/g' terraform/modules/aws/storage/main.tf

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.TF_ROOT }}

      - name: Terraform Apply
        working-directory: ${{ env.TF_ROOT }}
        env:
          TF_VAR_my_ip: ${{ secrets.ADMIN_IP_CIDR }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform apply -auto-approve tfplan